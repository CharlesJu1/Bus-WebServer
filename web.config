<?xml version="1.0" encoding="utf-8"?>
<configuration>

<!-- login https://buscoming.scm.azurewebsites.net/DebugConsole to acess applicationhost.config and 
     logfiles, debug console.

     Or go to the FTP site listed on the logs section of portal.azure.com using the FTP/deployment user name
     to download logs.  
-->

<system.webServer>

    <!-- indicates that the server.js file is a node.js application 
    to be handled by the iisnode module -->

    <handlers>
      <add name="iisnode" path="server.js" verb="*" modules="iisnode" />
    </handlers>

   <!-- TO turn off websocket in IIS for debugging iisnode with iisnode-inspector-0.7.3.dll
      <webSocket enabled="false" /> 
   -->
   
   <webSocket enabled="false" /> 
   
   
   <!-- IISNode.yml can override iisnode configuration in web.config 
   <iisnode 
      loggingEnabled="true"
      debuggingEnabled="true"
   />
   -->

    <!-- URL rewrite happens early in the pipeline. Handlers mapping will use the url after rewrite. 
         However, the original URL is passed to node.js for processing (not the rewritten url).    
         Here is configured so that everything is processed by server.js script. IIS will not serve static files.
         Static files will also be served by server.js.
    -->

    <rewrite>  
       <rules>  
            <rule name="LogFile" patternSyntax="ECMAScript" stopProcessing="true">  
                 <match url="iisnode" />  
            </rule>  
            <rule name="NodeInspector" patternSyntax="ECMAScript" stopProcessing="true">                      
                <match url="^server.js\/debug[\/]?" />  
            </rule>  
            <rule name="StaticContent" patternSyntax="ECMAScript" stopProcessing="true">               
                <match url="public/.*" />  
                <action type="None" logRewrittenUrl="true" />
            </rule>  
            <rule name="DynamicContent" patternSyntax="Wildcard">  
                 <match url="*" /> 
                 <action type="Rewrite" url="server.js" logRewrittenUrl="true" />                    
            </rule>  
       </rules>  
    </rewrite>

</system.webServer>
</configuration>